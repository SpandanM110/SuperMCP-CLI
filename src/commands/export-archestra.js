/**
 * Export-Archestra command - Generate Archestra-ready manifest for MCP server
 */

import fs from 'fs-extra';
import path from 'path';
import chalk from 'chalk';

export async function exportArchestraCommand(directory) {
  const dir = directory || process.cwd();

  const metaPath = path.join(dir, 'context', 'metadata.json');
  const meta = await fs.readJson(metaPath).catch(() => null);
  if (!meta) {
    console.log(chalk.red('Not a Super MCP project. Run from project directory.'));
    process.exit(1);
  }

  const pkg = await fs.readJson(path.join(dir, 'package.json')).catch(() => null);
  const projectName = pkg?.name || path.basename(dir);
  const serverName = projectName.replace(/-mcp$/, '') || projectName;

  const manifest = `# Archestra MCP Manifest - ${serverName}
# Generated by Super MCP. Import this into Archestra.

name: ${serverName}
transport: stdio
command: docker
args:
  - run
  - --rm
  - -i
  - --network=host
  - -e
  - LLM_PROVIDER=\${LLM_PROVIDER:-ollama}
  - -e
  - LLM_MODEL=\${LLM_MODEL:-llama3.2}
  - -e
  - OPENAI_API_KEY=\${OPENAI_API_KEY}
  - -e
  - ANTHROPIC_API_KEY=\${ANTHROPIC_API_KEY}
  - -e
  - GROQ_API_KEY=\${GROQ_API_KEY}
image: ${projectName}:latest

# Build first: docker build -t ${projectName}:latest .
# Then add this manifest to Archestra MCP Registry
`;

  const outPath = path.join(dir, 'archestra-manifest.yaml');
  await fs.writeFile(outPath, manifest);

  console.log(chalk.green(`\nâœ“ Exported archestra-manifest.yaml`));
  console.log(chalk.gray(outPath));
  console.log(chalk.cyan('\nNext steps:'));
  console.log(`  1. docker build -t ${projectName}:latest .`);
  console.log(`  2. Import archestra-manifest.yaml into Archestra MCP Registry\n`);
}
